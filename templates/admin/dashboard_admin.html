{% extends "admin/layout_admin.html" %}

{% block title %}Dashboard Admin Utama{% endblock %}

{% block head_extra %}
  <style>
    /* CSS dari dashboard_guru.html untuk konsistensi */
    .page-title {
      text-align: center;
      font-size: 2rem;
      color: #321B15;
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .container-custom {
      background-color: #ffffff;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .container-custom h2 {
      color: #321B15;
      margin-bottom: 1rem;
      border-bottom: 2px solid #321B15;
      padding-bottom: 0.5rem;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 0.75rem; text-align: left; vertical-align: middle; }
    th { background-color: #e9ecef; }
    .table-dark th { background-color: #321B15; color: #ECE5D8; }

    .nav-pills .nav-link { color: #321B15; font-weight: bold; }
    .nav-pills .nav-link.active { background-color: #321B15; color: #ECE5D8; }

    /* Gaya untuk kartu statistik */
    .card.border-left-primary { border-left: .25rem solid #4e73df!important; }
    .card.border-left-info { border-left: .25rem solid #36b9cc!important; }
    .card.border-left-warning { border-left: .25rem solid #f6c23e!important; }
    .card.border-left-danger { border-left: .25rem solid #e74a3b!important; }
    .text-gray-300 { color: #dddfeb!important; }
    .text-gray-800 { color: #5a5c69!important; }
    .text-xs { font-size: .7rem; }
    .font-weight-bold { font-weight: 700!important; }
    .text-uppercase { text-transform: uppercase!important; }
    .shadow { box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15)!important; }
    .py-2 { padding-top: .5rem!important; padding-bottom: .5rem!important; }
    .h-100 { height: 100%!important; }
    .no-gutters { margin-right: 0; margin-left: 0; }
    .no-gutters>.col, .no-gutters>[class*=col-] { padding-right: 0; padding-left: 0; }
    .align-items-center { align-items: center!important; }
    .mr-2 { margin-right: .5rem!important; }
    .mb-4 { margin-bottom: 1.5rem!important; }
    .action-buttons .btn, .action-buttons form { margin-right: 5px; margin-bottom: 5px;}
  </style>
{% endblock %}

{% block content %}
  <h1 class="page-title">Dashboard Administrasi Portal</h1>

  <ul class="nav nav-pills mb-3 justify-content-center flex-wrap" id="adminMainTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="ringkasan-tab" data-bs-toggle="tab" data-bs-target="#ringkasan-content" type="button" role="tab" aria-controls="ringkasan-content" aria-selected="true">
        <i class="fas fa-chart-bar me-1"></i> Ringkasan
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pengguna-tab" data-bs-toggle="tab" data-bs-target="#pengguna-content" type="button" role="tab" aria-controls="pengguna-content" aria-selected="false">
        <i class="fas fa-users-cog me-1"></i> Pengguna
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="ekskul-tab" data-bs-toggle="tab" data-bs-target="#ekskul-content" type="button" role="tab" aria-controls="ekskul-content" aria-selected="false">
        <i class="fas fa-clipboard-list me-1"></i> Ekstrakurikuler
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="materi-tab" data-bs-toggle="tab" data-bs-target="#materi-content" type="button" role="tab" aria-controls="materi-content" aria-selected="false">
        <i class="fas fa-book me-1"></i> Materi Ekskul
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pendaftaran-ekskul-tab" data-bs-toggle="tab" data-bs-target="#pendaftaran-ekskul-content" type="button" role="tab" aria-controls="pendaftaran-ekskul-content" aria-selected="false">
        <i class="fas fa-user-check me-1"></i> Pendaftaran Ekskul
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pengumuman-tab" data-bs-toggle="tab" data-bs-target="#pengumuman-content" type="button" role="tab" aria-controls="pengumuman-content" aria-selected="false">
        <i class="fas fa-bullhorn me-1"></i> Pengumuman
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="absensi-ekskul-tab" data-bs-toggle="tab" data-bs-target="#absensi-ekskul-content" type="button" role="tab" aria-controls="absensi-ekskul-content" aria-selected="false">
        <i class="fas fa-calendar-check me-1"></i> Absensi Ekskul
      </button>
    </li>
  </ul>

  <div class="tab-content" id="adminMainTabContent">
    {# Tab 1: Ringkasan Statistik #}
    <div class="tab-pane fade show active" id="ringkasan-content" role="tabpanel" aria-labelledby="ringkasan-tab">
      <section class="container-custom">
        <h2><i class="fas fa-chart-pie me-2"></i>Ringkasan Data Portal</h2>
        <div class="row mt-4">
          <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Pengguna</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ jumlah_pengguna }}</div>
                  </div>
                  <div class="col-auto">
                    <i class="fas fa-users fa-2x text-gray-300"></i>
                  </div>
                </div>
                <a href="#pengguna-tab" data-bs-toggle="tab" data-bs-target="#pengguna-content" class="stretched-link tab-link-from-card" title="Kelola Pengguna"></a>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Ekskul</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ jumlah_ekskul }}</div>
                  </div>
                  <div class="col-auto">
                    <i class="fas fa-puzzle-piece fa-2x text-gray-300"></i>
                  </div>
                </div>
                 <a href="#ekskul-tab" data-bs-toggle="tab" data-bs-target="#ekskul-content" class="stretched-link tab-link-from-card" title="Kelola Ekstrakurikuler"></a>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Pengumuman</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ jumlah_pengumuman }}</div>
                  </div>
                  <div class="col-auto">
                    <i class="fas fa-bullhorn fa-2x text-gray-300"></i>
                  </div>
                </div>
                <a href="#pengumuman-tab" data-bs-toggle="tab" data-bs-target="#pengumuman-content" class="stretched-link tab-link-from-card" title="Kelola Pengumuman"></a>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 mb-4"> 
            <div class="card border-left-danger shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Total Materi Ekskul</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ jumlah_materi_ekskul }}</div>
                  </div>
                  <div class="col-auto">
                    <i class="fas fa-book-open fa-2x text-gray-300"></i>
                  </div>
                </div>
                <a href="#materi-tab" data-bs-toggle="tab" data-bs-target="#materi-content" class="stretched-link tab-link-from-card" title="Kelola Materi Ekskul"></a>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    {# Tab 2: Pengguna #}
    {# Tab 2: Pengguna #}
    <div class="tab-pane fade" id="pengguna-content" role="tabpanel" aria-labelledby="pengguna-tab">
      <section class="container-custom">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-users-cog me-2"></i>Manajemen Pengguna</h2>
            <a href="{{ url_for('add_user_admin') }}" class="btn btn-primary">
                <i class="fas fa-user-plus me-1"></i> Tambah Pengguna Baru
            </a>
        </div>
        <hr>

        {# Daftar Admin #}
        <h3 class="mt-4">Daftar Admin</h3>
        {% if admins %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Nama Lengkap</th>
                        <th>Email</th>
                        <th>No. Admin</th>
                        <th>Status</th>
                        <th style="width: 15%;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in admins %}
                    <tr>
                        <td>{{ user.id_pengguna }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.nama_lengkap }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.nomor_induk if user.nomor_induk else '-' }}</td>
                        <td>
                            {% if user.status_aktif == 1 or user.status_aktif == True %} 
                                <span class="badge bg-success">Aktif</span>
                            {% else %}
                                <span class="badge bg-danger">Non-Aktif</span>
                            {% endif %}
                        </td>
                        <td class="action-buttons">
                            <a href="{{ url_for('edit_user_admin', user_id=user.id_pengguna) }}" class="btn btn-sm btn-outline-warning" title="Edit {{ user.nama_lengkap }}">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            {% if user.id_pengguna != session.user_id %}
                            <form action="{{ url_for('delete_user_admin', user_id=user.id_pengguna) }}" method="POST" style="display:inline;" onsubmit="return confirm('Apakah Anda yakin ingin menghapus pengguna {{ user.nama_lengkap }}? Tindakan ini tidak dapat diurungkan.');">
                                <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Hapus {{ user.nama_lengkap }}">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">Belum ada admin terdaftar.</div>
        {% endif %}

        {# Daftar Guru #}
        <h3 class="mt-5">Daftar Guru</h3>
        {% if gurus %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Nama Lengkap</th>
                        <th>Email</th>
                        <th>No. Induk (NIP)</th>
                        <th>Status</th>
                        <th style="width: 15%;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in gurus %}
                    <tr>
                        <td>{{ user.id_pengguna }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.nama_lengkap }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.nomor_induk if user.nomor_induk else '-' }}</td>
                        <td>
                            {% if user.status_aktif == 1 or user.status_aktif == True %} 
                                <span class="badge bg-success">Aktif</span>
                            {% else %}
                                <span class="badge bg-danger">Non-Aktif</span>
                            {% endif %}
                        </td>
                        <td class="action-buttons">
                            <a href="{{ url_for('edit_user_admin', user_id=user.id_pengguna) }}" class="btn btn-sm btn-outline-warning" title="Edit {{ user.nama_lengkap }}">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            {% if user.id_pengguna != session.user_id %} 
                            <form action="{{ url_for('delete_user_admin', user_id=user.id_pengguna) }}" method="POST" style="display:inline;" onsubmit="return confirm('Apakah Anda yakin ingin menghapus pengguna {{ user.nama_lengkap }}? Tindakan ini tidak dapat diurungkan.');">
                                <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Hapus {{ user.nama_lengkap }}">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">Belum ada guru terdaftar.</div>
        {% endif %}

        {# Daftar Murid #}
        <h3 class="mt-5">Daftar Murid</h3>
        {% if murids %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Nama Lengkap</th>
                        <th>Email</th>
                        <th>No. Induk (NIS)</th>
                        <th>Status</th>
                        <th style="width: 15%;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in murids %}
                    <tr>
                        <td>{{ user.id_pengguna }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.nama_lengkap }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.nomor_induk if user.nomor_induk else '-' }}</td>
                        <td>
                            {% if user.status_aktif == 1 or user.status_aktif == True %} 
                                <span class="badge bg-success">Aktif</span>
                            {% else %}
                                <span class="badge bg-danger">Non-Aktif</span>
                            {% endif %}
                        </td>
                        <td class="action-buttons">
                            <a href="{{ url_for('edit_user_admin', user_id=user.id_pengguna) }}" class="btn btn-sm btn-outline-warning" title="Edit {{ user.nama_lengkap }}">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            {% if user.id_pengguna != session.user_id %}
                            <form action="{{ url_for('delete_user_admin', user_id=user.id_pengguna) }}" method="POST" style="display:inline;" onsubmit="return confirm('Apakah Anda yakin ingin menghapus pengguna {{ user.nama_lengkap }}? Tindakan ini tidak dapat diurungkan.');">
                                <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Hapus {{ user.nama_lengkap }}">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">Belum ada murid terdaftar.</div>
        {% endif %}
      </section>
    </div>

    {# Tab 3: Ekstrakurikuler #}
    <div class="tab-pane fade" id="ekskul-content" role="tabpanel" aria-labelledby="ekskul-tab">
      <section class="container-custom">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-clipboard-list me-2"></i>Manajemen Ekstrakurikuler</h2>
            <a href="{{ url_for('add_ekskul_admin') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-1"></i> Tambah Ekskul Baru
            </a>
        </div>
        <hr>

        {# Jika tidak ada ekskul sama sekali #}
        {% if not ekskul_list %}
            <div class="alert alert-info text-center">Belum ada data ekstrakurikuler.</div>
        {% else %}
            {# Loop melalui kategori hasil groupby #}
            {% for kategori, items_in_kategori in ekskul_list|groupby('kategori') %}
                {# Tampilkan nama kategori sebagai heading #}
                {# Jika kategori adalah None atau string kosong, tampilkan "Tanpa Kategori" #}
                <h3 class="mt-4">{{ kategori if kategori and kategori|string|trim != "" else 'Tanpa Kategori' }}</h3>
                
                {% set items = items_in_kategori|list %} {# Konversi generator ke list untuk pengecekan #}
                {% if items %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 5%;">ID</th>
                                <th>Nama Ekskul</th>
                                <th>Pembina</th>
                                <th style="width: 10%;">Status</th>
                                <th>Jadwal</th>
                                <th>Lokasi</th>
                                <th style="width: 20%;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ekskul_item in items %}
                            <tr>
                                <td>{{ ekskul_item.id_ekskul }}</td>
                                <td>{{ ekskul_item.nama_ekskul }}</td>
                                <td>{{ ekskul_item.nama_guru_pembina if ekskul_item.nama_guru_pembina else '-' }}</td>
                                <td>
                                    {% if ekskul_item.status_aktif %}
                                        <span class="badge bg-success">Aktif</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Non-Aktif</span>
                                    {% endif %}
                                </td>
                                <td>{{ ekskul_item.jadwal_deskripsi if ekskul_item.jadwal_deskripsi else '-' }}</td>
                                <td>{{ ekskul_item.lokasi if ekskul_item.lokasi else '-' }}</td>
                                <td class="action-buttons">
                                    <a href="{{ url_for('ekskul_detail_admin', ekskul_id=ekskul_item.id_ekskul) }}" class="btn btn-sm btn-outline-info mb-1" title="Lihat Detail {{ ekskul_item.nama_ekskul }}">
                                        <i class="fas fa-eye"></i> Detail
                                    </a>
                                    <a href="{{ url_for('edit_ekskul_admin', ekskul_id=ekskul_item.id_ekskul) }}" class="btn btn-sm btn-outline-warning mb-1" title="Edit {{ ekskul_item.nama_ekskul }}">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <form action="{{ url_for('delete_ekskul_admin', ekskul_id=ekskul_item.id_ekskul) }}" method="POST" style="display:inline;" onsubmit="return confirm('Apakah Anda yakin ingin menghapus ekskul {{ ekskul_item.nama_ekskul }}? Semua data pendaftaran siswa dan materi di ekskul ini juga akan terhapus.');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger mb-1" title="Hapus {{ ekskul_item.nama_ekskul }}">
                                            <i class="fas fa-trash"></i> Hapus
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    {# Seharusnya tidak terjadi jika groupby menghasilkan grup, tapi sebagai fallback #}
                    <p>Tidak ada ekstrakurikuler dalam kategori ini.</p>
                {% endif %}
            {% endfor %}
        {% endif %} {# Akhir dari if not ekskul_list #}
      </section>
    </div>

    {# Tab 4: Materi Ekskul #}
    <div class="tab-pane fade" id="materi-content" role="tabpanel" aria-labelledby="materi-tab">
      <section class="container-custom">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-book me-2"></i>Manajemen Materi Ekstrakurikuler</h2>
            <a href="{{ url_for('tambah_materi_ekskul_admin') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-1"></i> Tambah Materi Baru
            </a>
        </div>
        <hr>

        {% if list_materi %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Judul Materi</th>
                        <th>Ekskul</th>
                        <th>Tipe Konten</th>
                        <th>Pengunggah</th>
                        <th>Tgl Unggah</th>
                        <th style="width: 15%;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for materi in list_materi %}
                    <tr>
                        <td>{{ materi.judul_materi }}</td>
                        <td>{{ materi.nama_ekskul }}</td>
                        <td>{{ materi.tipe_konten|capitalize }}</td>
                        <td>{{ materi.nama_pengunggah }}</td>
                        <td>{{ materi.tanggal_unggah.strftime('%d-%m-%Y %H:%M') if materi.tanggal_unggah else '-'}}</td>
                        <td class="action-buttons">
                            <a href="{{ url_for('edit_materi_ekskul_admin', id_materi_ekskul=materi.id_materi_ekskul) }}" class="btn btn-sm btn-outline-warning mb-1" title="Edit Materi {{ materi.judul_materi }}">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <form action="{{ url_for('hapus_materi_ekskul_admin', id_materi_ekskul=materi.id_materi_ekskul) }}" method="POST" style="display:inline;" onsubmit="return confirm('Apakah Anda yakin ingin menghapus materi \'{{ materi.judul_materi }}\'?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger mb-1" title="Hapus Materi {{ materi.judul_materi }}">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center">Belum ada materi ekstrakurikuler yang ditambahkan.</div>
        {% endif %}
      </section>
    </div>

    {# Tab 5: Pendaftaran Ekskul #}
    <div class="tab-pane fade" id="pendaftaran-ekskul-content" role="tabpanel" aria-labelledby="pendaftaran-ekskul-tab">
        <section class="container-custom">
            <h2><i class="fas fa-user-check me-2"></i>Kelola Pendaftaran Ekstrakurikuler</h2>
            <hr>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% if pending_registrations %}
            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Tanggal Daftar</th>
                            <th>Nama Murid</th>
                            <th>No. Induk</th>
                            <th>Ekskul</th>
                            <th>Pembina</th>
                            <th>Tahun Ajaran</th>
                            <th style="width: 18%;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reg in pending_registrations %}
                        <tr>
                            <td>{{ reg.tanggal_pendaftaran.strftime('%d-%m-%Y %H:%M') if reg.tanggal_pendaftaran else 'N/A' }}</td>
                            <td>{{ reg.nama_murid }}</td>
                            <td>{{ reg.nomor_induk_murid | default('N/A', true) }}</td>
                            <td>{{ reg.nama_ekskul }}</td>
                            <td>{{ reg.nama_pembina | default('N/A', true) }}</td>
                            <td>{{ reg.tahun_ajaran }}</td>
                            <td class="action-buttons">
                                <form action="{{ url_for('setujui_pendaftaran_admin', pendaftaran_id=reg.id_pendaftaran_ekskul) }}" method="POST" class="d-inline" onsubmit="return confirm('Anda yakin ingin MENYETUJUI pendaftaran untuk {{ reg.nama_murid }} di ekskul {{ reg.nama_ekskul }}?')">
                                    <button type="submit" class="btn btn-success btn-sm" title="Setujui Pendaftaran">
                                        <i class="fas fa-check"></i> Setujui
                                    </button>
                                </form>
                                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#tolakModalAdmin{{ reg.id_pendaftaran_ekskul }}" title="Tolak Pendaftaran">
                                    <i class="fas fa-times"></i> Tolak
                                </button>

                                <div class="modal fade" id="tolakModalAdmin{{ reg.id_pendaftaran_ekskul }}" tabindex="-1" aria-labelledby="tolakModalAdminLabel{{ reg.id_pendaftaran_ekskul }}" aria-hidden="true">
                                  <div class="modal-dialog">
                                    <div class="modal-content">
                                      <form action="{{ url_for('tolak_pendaftaran_admin', pendaftaran_id=reg.id_pendaftaran_ekskul) }}" method="POST">
                                        <div class="modal-header">
                                          <h5 class="modal-title" id="tolakModalAdminLabel{{ reg.id_pendaftaran_ekskul }}">Tolak Pendaftaran: {{ reg.nama_murid }} - {{ reg.nama_ekskul }}</h5>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                          <div class="mb-3">
                                            <label for="alasan_penolakan_admin_{{ reg.id_pendaftaran_ekskul }}" class="form-label">Alasan Penolakan (Opsional):</label>
                                            <textarea class="form-control" id="alasan_penolakan_admin_{{ reg.id_pendaftaran_ekskul }}" name="alasan_penolakan" rows="3"></textarea>
                                          </div>
                                        </div>
                                        <div class="modal-footer">
                                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                          <button type="submit" class="btn btn-danger">Ya, Tolak Pendaftaran</button>
                                        </div>
                                      </form>
                                    </div>
                                  </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info mt-3" role="alert">
                Tidak ada pendaftaran ekstrakurikuler yang menunggu persetujuan saat ini.
            </div>
            {% endif %}
        </section>
    </div>

    {# Tab 6: Pengumuman #}
    <div class="tab-pane fade" id="pengumuman-content" role="tabpanel" aria-labelledby="pengumuman-tab">
      <section class="container-custom">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-bullhorn me-2"></i>Manajemen Pengumuman</h2>
            <a href="{{ url_for('tambah_pengumuman_admin') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-1"></i> Tambah Pengumuman Baru
            </a>
        </div>
        <hr>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if list_pengumuman %}
        <div class="table-responsive mt-3">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Judul</th>
                        <th>Isi Singkat</th>
                        <th>Tgl Publikasi</th>
                        <th>Pembuat</th>
                        <th>Target Peran</th>
                        <th>Target Ekskul</th>
                        <th style="width: 15%;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in list_pengumuman %}
                    <tr>
                        <td>{{ p.judul_pengumuman }}</td>
                        <td>{{ p.isi_pengumuman|truncate(70, true, '...') }}</td> {# Sedikit lebih pendek untuk tabel #}
                        <td>{{ p.tanggal_publikasi.strftime('%d %b %Y, %H:%M') if p.tanggal_publikasi else '-' }}</td>
                        <td>{{ p.nama_pembuat if p.nama_pembuat else '-' }}</td>
                        <td>{{ p.target_peran|capitalize if p.target_peran else 'Semua' }}</td>
                        {# PERHATIAN: Kolom 'Target Kelas' (p.nama_target_kelas) #}
                        {# bergantung pada apakah Anda masih menyertakan logika untuk ini di config.py dan database. #}
                        {# Jika sudah dihapus sesuai saran sebelumnya, hapus kolom <td> ini juga. #}
                        <td>{{ p.nama_target_ekskul if p.nama_target_ekskul else '-' }}</td>
                        <td class="action-buttons">
                            <a href="{{ url_for('edit_pengumuman_admin', id_pengumuman=p.id_pengumuman) }}" class="btn btn-outline-warning btn-sm mb-1" title="Edit Pengumuman">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <form action="{{ url_for('hapus_pengumuman_admin', id_pengumuman=p.id_pengumuman) }}" method="POST" style="display:inline;" onsubmit="return confirm('Apakah Anda yakin ingin menghapus pengumuman \'{{ p.judul_pengumuman|escape }}\'?');">
                                <button type="submit" class="btn btn-outline-danger btn-sm mb-1" title="Hapus Pengumuman">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info mt-3" role="alert">
            Belum ada pengumuman yang dibuat.
        </div>
        {% endif %}
      </section>
    </div>

    {# Tab 7: Absensi Ekskul #}
    <div class="tab-pane fade" id="absensi-ekskul-content" role="tabpanel" aria-labelledby="absensi-ekskul-tab">
        <section class="container-custom">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><i class="fas fa-calendar-check me-2"></i>Manajemen Absensi Ekstrakurikuler</h2>
                <a href="{{ url_for('manage_absensi_ekskul_admin') }}" class="btn btn-primary">
                    <i class="fas fa-plus-circle me-1"></i> Tambah/Edit Entri Absensi
                </a>
            </div>
            <hr>

            {% if absensi_list %}
            <div class="table-responsive mt-2">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Tgl Kegiatan</th>
                            <th>Ekskul</th>
                            <th>Nama Murid</th>
                            <th>Status</th>
                            <th>Jam Mulai</th>
                            <th>Catatan</th>
                            <th>Dicatat Oleh</th>
                            <th>Tgl Dicatat</th>
                            <th style="width: 10%;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for absen in absensi_list %}
                        <tr>
                            <td>{{ absen.tanggal_kegiatan.strftime('%d-%m-%Y') if absen.tanggal_kegiatan else '-' }}</td>
                            <td>{{ absen.nama_ekskul }}</td>
                            <td>{{ absen.nama_murid }}</td>
                            <td>
                                <span class="badge 
                                {% if absen.status_kehadiran == 'Hadir' %}bg-success
                                {% elif absen.status_kehadiran == 'Izin' %}bg-info text-dark
                                {% elif absen.status_kehadiran == 'Sakit' %}bg-warning text-dark
                                {% elif absen.status_kehadiran == 'Alfa' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ absen.status_kehadiran }}</span>
                            </td>
                            <td>
                                {# Logika untuk format jam_mulai_kegiatan jika itu timedelta #}
                                {% if absen.jam_mulai_kegiatan %}
                                    {% if absen.jam_mulai_kegiatan is string %}
                                        {{ absen.jam_mulai_kegiatan }} {# Jika sudah string HH:MM #}
                                    {% elif absen.jam_mulai_kegiatan.strftime is callable %}
                                        {{ absen.jam_mulai_kegiatan_formatted }} {# Jika objek time/datetime #}
                                    {% else %}
                                        {{ absen.jam_mulai_kegiatan }} {# Fallback #}
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ absen.catatan|truncate(40,true,'...') if absen.catatan else '-' }}</td>
                            <td>{{ absen.nama_pencatat if absen.nama_pencatat else '-' }}</td>
                            <td>{{ absen.tanggal_dicatat.strftime('%d-%m-%Y %H:%M') if absen.tanggal_dicatat else '-' }}</td>
                            <td class="action-buttons">
                                <a href="{{ url_for('manage_absensi_ekskul_admin', id_pendaftaran_ekskul=absen.id_pendaftaran_ekskul, tanggal_kegiatan_str=absen.tanggal_kegiatan.strftime('%Y-%m-%d')) }}" class="btn btn-sm btn-outline-warning mb-1" title="Edit Absensi">Edit
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form action="{{ url_for('hapus_absensi_ekskul_admin', id_absensi_ekskul=absen.id_absensi_ekskul) }}" method="POST" style="display:inline;" onsubmit="return confirm('Yakin hapus entri absensi untuk {{ absen.nama_murid }} pada {{ absen.tanggal_kegiatan.strftime('%d-%m-%Y') }}?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger mb-1" title="Hapus Absensi">Hapus
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info mt-3" role="alert">
                Belum ada data absensi ekstrakurikuler yang tercatat.
            </div>
            {% endif %}
        </section>
    </div>

  </div>

{% endblock %}

{% block scripts_extra %}
{# Pastikan Bootstrap JS bundle dan Font Awesome sudah ada di layout_admin.html #}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Inisialisasi Tabs Bootstrap
    var triggerTabList = [].slice.call(document.querySelectorAll('#adminMainTab .nav-link'));
    triggerTabList.forEach(function (triggerEl) {
      var tabTrigger = new bootstrap.Tab(triggerEl);
      triggerEl.addEventListener('click', function (event) {
        event.preventDefault();
        tabTrigger.show();
        // Update hash di URL (opsional, untuk bookmark atau refresh)
        // window.location.hash = triggerEl.getAttribute('data-bs-target');
      });
    });
    
    // Jika ada tab yang aktif dari URL hash, aktifkan
    if(window.location.hash) {
      var activeTabButton = document.querySelector('#adminMainTab .nav-link[data-bs-target="' + window.location.hash + '"]');
      if (activeTabButton) {
        (new bootstrap.Tab(activeTabButton)).show();
      }
    }

    // Fungsionalitas untuk link dari kartu statistik ke tab
    var cardLinks = document.querySelectorAll('.tab-link-from-card');
    cardLinks.forEach(function(link) {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            var targetTabSelector = this.getAttribute('data-bs-target') || this.getAttribute('href'); // e.g., #pengguna-content
            var targetTabButton = document.querySelector('.nav-link[data-bs-target="' + targetTabSelector + '"]');
            if (targetTabButton) {
                (new bootstrap.Tab(targetTabButton)).show();
                // Gulir ke tab yang bersangkutan (opsional)
                // document.querySelector(targetTabSelector).scrollIntoView({ behavior: 'smooth' });
            }
        });
    });

  });
</script>
{% endblock %}